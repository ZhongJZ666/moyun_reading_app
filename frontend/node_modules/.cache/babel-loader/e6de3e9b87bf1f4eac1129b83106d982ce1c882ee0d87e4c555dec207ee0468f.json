{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { formatDistanceToNow } from 'date-fns';\nimport { zhCN } from 'date-fns/locale';\nexport default {\n  name: 'MessageChat',\n  props: {\n    targetUser: {\n      type: Object,\n      required: true\n    }\n  },\n  data() {\n    return {\n      messages: [],\n      inputMessage: '',\n      loading: false,\n      hasMore: true,\n      page: 1,\n      pageSize: 20,\n      currentUser: this.$store.state.user\n    };\n  },\n  created() {\n    this.fetchMessages();\n    this.setupWebSocket();\n  },\n  beforeUnmount() {\n    this.cleanupWebSocket();\n  },\n  methods: {\n    async fetchMessages() {\n      this.loading = true;\n      try {\n        const response = await this.$http.get(`/api/messages/chat/${this.targetUser.id}`, {\n          params: {\n            page: this.page,\n            size: this.pageSize\n          }\n        });\n        if (this.page === 1) {\n          this.messages = response.data.items.reverse();\n        } else {\n          this.messages.unshift(...response.data.items.reverse());\n        }\n        this.hasMore = response.data.hasMore;\n        this.$nextTick(() => {\n          this.scrollToBottom();\n        });\n      } catch (error) {\n        this.$message.error('获取消息失败');\n      } finally {\n        this.loading = false;\n      }\n    },\n    handleScroll() {\n      const container = this.$refs.messageContainer;\n      if (container.scrollTop === 0 && this.hasMore) {\n        this.loadMore();\n      }\n    },\n    async loadMore() {\n      this.page++;\n      await this.fetchMessages();\n    },\n    formatTime(time) {\n      return formatDistanceToNow(new Date(time), {\n        addSuffix: true,\n        locale: zhCN\n      });\n    },\n    async sendMessage() {\n      if (!this.inputMessage.trim()) return;\n      try {\n        const response = await this.$http.post('/api/messages', {\n          receiverId: this.targetUser.id,\n          content: this.inputMessage.trim()\n        });\n        this.messages.push(response.data);\n        this.inputMessage = '';\n        this.$nextTick(() => {\n          this.scrollToBottom();\n        });\n      } catch (error) {\n        this.$message.error('发送消息失败');\n      }\n    },\n    scrollToBottom() {\n      const container = this.$refs.messageContainer;\n      container.scrollTop = container.scrollHeight;\n    },\n    showUserProfile() {\n      this.$router.push(`/users/${this.targetUser.id}`);\n    },\n    setupWebSocket() {\n      this.ws = new WebSocket(`${process.env.VUE_APP_WS_URL}/ws/messages`);\n      this.ws.onmessage = event => {\n        const message = JSON.parse(event.data);\n        if (message.senderId === this.targetUser.id) {\n          this.messages.push(message);\n          this.$nextTick(() => {\n            this.scrollToBottom();\n          });\n        }\n      };\n    },\n    cleanupWebSocket() {\n      if (this.ws) {\n        this.ws.close();\n      }\n    }\n  }\n};","map":{"version":3,"names":["formatDistanceToNow","zhCN","name","props","targetUser","type","Object","required","data","messages","inputMessage","loading","hasMore","page","pageSize","currentUser","$store","state","user","created","fetchMessages","setupWebSocket","beforeUnmount","cleanupWebSocket","methods","response","$http","get","id","params","size","items","reverse","unshift","$nextTick","scrollToBottom","error","$message","handleScroll","container","$refs","messageContainer","scrollTop","loadMore","formatTime","time","Date","addSuffix","locale","sendMessage","trim","post","receiverId","content","push","scrollHeight","showUserProfile","$router","ws","WebSocket","process","env","VUE_APP_WS_URL","onmessage","event","message","JSON","parse","senderId","close"],"sources":["C:\\Users\\仲佳泽\\Desktop\\大学作业\\软件工程\\moyun-reading-platform\\frontend\\src\\views\\message\\MessageChat.vue"],"sourcesContent":["<template>\r\n  <div class=\"message-chat\">\r\n    <!-- 聊天头部 -->\r\n    <div class=\"chat-header\">\r\n      <div class=\"user-info\">\r\n        <el-avatar\r\n          :size=\"40\"\r\n          :src=\"targetUser?.avatar\"\r\n        />\r\n        <div class=\"user-details\">\r\n          <span class=\"username\">{{ targetUser?.username }}</span>\r\n          <span class=\"status\">{{ targetUser?.online ? '在线' : '离线' }}</span>\r\n        </div>\r\n      </div>\r\n      <div class=\"header-actions\">\r\n        <el-button\r\n          type=\"primary\"\r\n          link\r\n          @click=\"showUserProfile\"\r\n        >\r\n          查看资料\r\n        </el-button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 消息列表 -->\r\n    <div\r\n      ref=\"messageContainer\"\r\n      class=\"message-container\"\r\n      @scroll=\"handleScroll\"\r\n    >\r\n      <div\r\n        v-if=\"hasMore\"\r\n        class=\"load-more\"\r\n      >\r\n        <el-button\r\n          :loading=\"loading\"\r\n          @click=\"loadMore\"\r\n        >\r\n          加载更多\r\n        </el-button>\r\n      </div>\r\n\r\n      <div class=\"message-list\">\r\n        <div\r\n          v-for=\"message in messages\"\r\n          :key=\"message.id\"\r\n          class=\"message-item\"\r\n          :class=\"{ 'message-mine': message.senderId === currentUser.id }\"\r\n        >\r\n          <el-avatar\r\n            :size=\"36\"\r\n            :src=\"message.senderId === currentUser.id ? currentUser.avatar : targetUser?.avatar\"\r\n          />\r\n          <div class=\"message-content\">\r\n            <div class=\"message-time\">\r\n              {{ formatTime(message.createTime) }}\r\n            </div>\r\n            <div class=\"message-bubble\">\r\n              {{ message.content }}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 输入框 -->\r\n    <div class=\"chat-input\">\r\n      <el-input\r\n        v-model=\"inputMessage\"\r\n        type=\"textarea\"\r\n        :rows=\"3\"\r\n        placeholder=\"输入消息...\"\r\n        :maxlength=\"1000\"\r\n        show-word-limit\r\n        @keyup.enter.ctrl=\"sendMessage\"\r\n      />\r\n      <div class=\"input-actions\">\r\n        <span class=\"tip\">按 Ctrl + Enter 发送</span>\r\n        <el-button\r\n          type=\"primary\"\r\n          :disabled=\"!inputMessage.trim()\"\r\n          @click=\"sendMessage\"\r\n        >\r\n          发送\r\n        </el-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { formatDistanceToNow } from 'date-fns'\r\nimport { zhCN } from 'date-fns/locale'\r\n\r\nexport default {\r\n  name: 'MessageChat',\r\n  props: {\r\n    targetUser: {\r\n      type: Object,\r\n      required: true\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      messages: [],\r\n      inputMessage: '',\r\n      loading: false,\r\n      hasMore: true,\r\n      page: 1,\r\n      pageSize: 20,\r\n      currentUser: this.$store.state.user\r\n    }\r\n  },\r\n  created() {\r\n    this.fetchMessages()\r\n    this.setupWebSocket()\r\n  },\r\n  beforeUnmount() {\r\n    this.cleanupWebSocket()\r\n  },\r\n  methods: {\r\n    async fetchMessages() {\r\n      this.loading = true\r\n      try {\r\n        const response = await this.$http.get(`/api/messages/chat/${this.targetUser.id}`, {\r\n          params: {\r\n            page: this.page,\r\n            size: this.pageSize\r\n          }\r\n        })\r\n        if (this.page === 1) {\r\n          this.messages = response.data.items.reverse()\r\n        } else {\r\n          this.messages.unshift(...response.data.items.reverse())\r\n        }\r\n        this.hasMore = response.data.hasMore\r\n        this.$nextTick(() => {\r\n          this.scrollToBottom()\r\n        })\r\n      } catch (error) {\r\n        this.$message.error('获取消息失败')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n    handleScroll() {\r\n      const container = this.$refs.messageContainer\r\n      if (container.scrollTop === 0 && this.hasMore) {\r\n        this.loadMore()\r\n      }\r\n    },\r\n    async loadMore() {\r\n      this.page++\r\n      await this.fetchMessages()\r\n    },\r\n    formatTime(time) {\r\n      return formatDistanceToNow(new Date(time), {\r\n        addSuffix: true,\r\n        locale: zhCN\r\n      })\r\n    },\r\n    async sendMessage() {\r\n      if (!this.inputMessage.trim()) return\r\n\r\n      try {\r\n        const response = await this.$http.post('/api/messages', {\r\n          receiverId: this.targetUser.id,\r\n          content: this.inputMessage.trim()\r\n        })\r\n        this.messages.push(response.data)\r\n        this.inputMessage = ''\r\n        this.$nextTick(() => {\r\n          this.scrollToBottom()\r\n        })\r\n      } catch (error) {\r\n        this.$message.error('发送消息失败')\r\n      }\r\n    },\r\n    scrollToBottom() {\r\n      const container = this.$refs.messageContainer\r\n      container.scrollTop = container.scrollHeight\r\n    },\r\n    showUserProfile() {\r\n      this.$router.push(`/users/${this.targetUser.id}`)\r\n    },\r\n    setupWebSocket() {\r\n      this.ws = new WebSocket(`${process.env.VUE_APP_WS_URL}/ws/messages`)\r\n      this.ws.onmessage = (event) => {\r\n        const message = JSON.parse(event.data)\r\n        if (message.senderId === this.targetUser.id) {\r\n          this.messages.push(message)\r\n          this.$nextTick(() => {\r\n            this.scrollToBottom()\r\n          })\r\n        }\r\n      }\r\n    },\r\n    cleanupWebSocket() {\r\n      if (this.ws) {\r\n        this.ws.close()\r\n      }\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.message-chat {\r\n  display: flex;\r\n  flex-direction: column;\r\n  height: 100%;\r\n  background-color: var(--background-color);\r\n}\r\n\r\n.chat-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 15px;\r\n  background-color: var(--background-color-light);\r\n  border-bottom: 1px solid var(--border-color);\r\n\r\n  .user-info {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n  }\r\n\r\n  .user-details {\r\n    display: flex;\r\n    flex-direction: column;\r\n\r\n    .username {\r\n      font-weight: bold;\r\n      color: var(--text-color);\r\n    }\r\n\r\n    .status {\r\n      font-size: 12px;\r\n      color: var(--text-color-secondary);\r\n    }\r\n  }\r\n}\r\n\r\n.message-container {\r\n  flex: 1;\r\n  overflow-y: auto;\r\n  padding: 20px;\r\n}\r\n\r\n.load-more {\r\n  display: flex;\r\n  justify-content: center;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.message-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 20px;\r\n}\r\n\r\n.message-item {\r\n  display: flex;\r\n  gap: 10px;\r\n  max-width: 80%;\r\n\r\n  &.message-mine {\r\n    flex-direction: row-reverse;\r\n    align-self: flex-end;\r\n\r\n    .message-content {\r\n      align-items: flex-end;\r\n    }\r\n\r\n    .message-bubble {\r\n      background-color: var(--primary-color);\r\n      color: white;\r\n    }\r\n  }\r\n}\r\n\r\n.message-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 5px;\r\n}\r\n\r\n.message-time {\r\n  font-size: 12px;\r\n  color: var(--text-color-secondary);\r\n}\r\n\r\n.message-bubble {\r\n  padding: 10px 15px;\r\n  background-color: var(--background-color-light);\r\n  border-radius: 8px;\r\n  word-break: break-word;\r\n}\r\n\r\n.chat-input {\r\n  padding: 15px;\r\n  background-color: var(--background-color-light);\r\n  border-top: 1px solid var(--border-color);\r\n\r\n  .input-actions {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-top: 10px;\r\n\r\n    .tip {\r\n      font-size: 12px;\r\n      color: var(--text-color-secondary);\r\n    }\r\n  }\r\n}\r\n</style> "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}