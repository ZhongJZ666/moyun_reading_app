{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, resolveComponent as _resolveComponent, createVNode as _createVNode, toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, createTextVNode as _createTextVNode, withCtx as _withCtx, openBlock as _openBlock, createElementBlock as _createElementBlock, renderList as _renderList, Fragment as _Fragment, normalizeClass as _normalizeClass, withModifiers as _withModifiers, withKeys as _withKeys } from \"vue\";\nconst _hoisted_1 = {\n  class: \"message-chat\"\n};\nconst _hoisted_2 = {\n  class: \"chat-header\"\n};\nconst _hoisted_3 = {\n  class: \"user-info\"\n};\nconst _hoisted_4 = {\n  class: \"user-details\"\n};\nconst _hoisted_5 = {\n  class: \"username\"\n};\nconst _hoisted_6 = {\n  class: \"status\"\n};\nconst _hoisted_7 = {\n  class: \"header-actions\"\n};\nconst _hoisted_8 = {\n  key: 0,\n  class: \"load-more\"\n};\nconst _hoisted_9 = {\n  class: \"message-list\"\n};\nconst _hoisted_10 = {\n  class: \"message-content\"\n};\nconst _hoisted_11 = {\n  class: \"message-time\"\n};\nconst _hoisted_12 = {\n  class: \"message-bubble\"\n};\nconst _hoisted_13 = {\n  class: \"chat-input\"\n};\nconst _hoisted_14 = {\n  class: \"input-actions\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_avatar = _resolveComponent(\"el-avatar\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_el_input = _resolveComponent(\"el-input\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createCommentVNode(\" 聊天头部 \"), _createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createVNode(_component_el_avatar, {\n    size: 40,\n    src: $props.targetUser?.avatar\n  }, null, 8 /* PROPS */, [\"src\"]), _createElementVNode(\"div\", _hoisted_4, [_createElementVNode(\"span\", _hoisted_5, _toDisplayString($props.targetUser?.username), 1 /* TEXT */), _createElementVNode(\"span\", _hoisted_6, _toDisplayString($props.targetUser?.online ? '在线' : '离线'), 1 /* TEXT */)])]), _createElementVNode(\"div\", _hoisted_7, [_createVNode(_component_el_button, {\n    type: \"primary\",\n    link: \"\",\n    onClick: $options.showUserProfile\n  }, {\n    default: _withCtx(() => _cache[2] || (_cache[2] = [_createTextVNode(\" 查看资料 \")])),\n    _: 1 /* STABLE */,\n    __: [2]\n  }, 8 /* PROPS */, [\"onClick\"])])]), _createCommentVNode(\" 消息列表 \"), _createElementVNode(\"div\", {\n    ref: \"messageContainer\",\n    class: \"message-container\",\n    onScroll: _cache[0] || (_cache[0] = (...args) => $options.handleScroll && $options.handleScroll(...args))\n  }, [$data.hasMore ? (_openBlock(), _createElementBlock(\"div\", _hoisted_8, [_createVNode(_component_el_button, {\n    loading: $data.loading,\n    onClick: $options.loadMore\n  }, {\n    default: _withCtx(() => _cache[3] || (_cache[3] = [_createTextVNode(\" 加载更多 \")])),\n    _: 1 /* STABLE */,\n    __: [3]\n  }, 8 /* PROPS */, [\"loading\", \"onClick\"])])) : _createCommentVNode(\"v-if\", true), _createElementVNode(\"div\", _hoisted_9, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($data.messages, message => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: message.id,\n      class: _normalizeClass([\"message-item\", {\n        'message-mine': message.senderId === $data.currentUser.id\n      }])\n    }, [_createVNode(_component_el_avatar, {\n      size: 36,\n      src: message.senderId === $data.currentUser.id ? $data.currentUser.avatar : $props.targetUser?.avatar\n    }, null, 8 /* PROPS */, [\"src\"]), _createElementVNode(\"div\", _hoisted_10, [_createElementVNode(\"div\", _hoisted_11, _toDisplayString($options.formatTime(message.createTime)), 1 /* TEXT */), _createElementVNode(\"div\", _hoisted_12, _toDisplayString(message.content), 1 /* TEXT */)])], 2 /* CLASS */);\n  }), 128 /* KEYED_FRAGMENT */))])], 544 /* NEED_HYDRATION, NEED_PATCH */), _createCommentVNode(\" 输入框 \"), _createElementVNode(\"div\", _hoisted_13, [_createVNode(_component_el_input, {\n    modelValue: $data.inputMessage,\n    \"onUpdate:modelValue\": _cache[1] || (_cache[1] = $event => $data.inputMessage = $event),\n    type: \"textarea\",\n    rows: 3,\n    placeholder: \"输入消息...\",\n    maxlength: 1000,\n    \"show-word-limit\": \"\",\n    onKeyup: _withKeys(_withModifiers($options.sendMessage, [\"ctrl\"]), [\"enter\"])\n  }, null, 8 /* PROPS */, [\"modelValue\", \"onKeyup\"]), _createElementVNode(\"div\", _hoisted_14, [_cache[5] || (_cache[5] = _createElementVNode(\"span\", {\n    class: \"tip\"\n  }, \"按 Ctrl + Enter 发送\", -1 /* HOISTED */)), _createVNode(_component_el_button, {\n    type: \"primary\",\n    disabled: !$data.inputMessage.trim(),\n    onClick: $options.sendMessage\n  }, {\n    default: _withCtx(() => _cache[4] || (_cache[4] = [_createTextVNode(\" 发送 \")])),\n    _: 1 /* STABLE */,\n    __: [4]\n  }, 8 /* PROPS */, [\"disabled\", \"onClick\"])])])]);\n}","map":{"version":3,"names":["class","key","_createElementBlock","_hoisted_1","_createCommentVNode","_createElementVNode","_hoisted_2","_hoisted_3","_createVNode","_component_el_avatar","size","src","$props","targetUser","avatar","_hoisted_4","_hoisted_5","_toDisplayString","username","_hoisted_6","online","_hoisted_7","_component_el_button","type","link","onClick","$options","showUserProfile","default","_withCtx","_cache","_createTextVNode","_","__","ref","onScroll","args","handleScroll","$data","hasMore","_hoisted_8","loading","loadMore","_hoisted_9","_Fragment","_renderList","messages","message","id","_normalizeClass","senderId","currentUser","_hoisted_10","_hoisted_11","formatTime","createTime","_hoisted_12","content","_hoisted_13","_component_el_input","modelValue","inputMessage","$event","rows","placeholder","maxlength","onKeyup","_withKeys","_withModifiers","sendMessage","_hoisted_14","disabled","trim"],"sources":["E:\\moyun-reading-platform\\moyun-reading-platform\\frontend\\src\\views\\message\\MessageChat.vue"],"sourcesContent":["<template>\r\n  <div class=\"message-chat\">\r\n    <!-- 聊天头部 -->\r\n    <div class=\"chat-header\">\r\n      <div class=\"user-info\">\r\n        <el-avatar\r\n          :size=\"40\"\r\n          :src=\"targetUser?.avatar\"\r\n        />\r\n        <div class=\"user-details\">\r\n          <span class=\"username\">{{ targetUser?.username }}</span>\r\n          <span class=\"status\">{{ targetUser?.online ? '在线' : '离线' }}</span>\r\n        </div>\r\n      </div>\r\n      <div class=\"header-actions\">\r\n        <el-button\r\n          type=\"primary\"\r\n          link\r\n          @click=\"showUserProfile\"\r\n        >\r\n          查看资料\r\n        </el-button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 消息列表 -->\r\n    <div\r\n      ref=\"messageContainer\"\r\n      class=\"message-container\"\r\n      @scroll=\"handleScroll\"\r\n    >\r\n      <div\r\n        v-if=\"hasMore\"\r\n        class=\"load-more\"\r\n      >\r\n        <el-button\r\n          :loading=\"loading\"\r\n          @click=\"loadMore\"\r\n        >\r\n          加载更多\r\n        </el-button>\r\n      </div>\r\n\r\n      <div class=\"message-list\">\r\n        <div\r\n          v-for=\"message in messages\"\r\n          :key=\"message.id\"\r\n          class=\"message-item\"\r\n          :class=\"{ 'message-mine': message.senderId === currentUser.id }\"\r\n        >\r\n          <el-avatar\r\n            :size=\"36\"\r\n            :src=\"message.senderId === currentUser.id ? currentUser.avatar : targetUser?.avatar\"\r\n          />\r\n          <div class=\"message-content\">\r\n            <div class=\"message-time\">\r\n              {{ formatTime(message.createTime) }}\r\n            </div>\r\n            <div class=\"message-bubble\">\r\n              {{ message.content }}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 输入框 -->\r\n    <div class=\"chat-input\">\r\n      <el-input\r\n        v-model=\"inputMessage\"\r\n        type=\"textarea\"\r\n        :rows=\"3\"\r\n        placeholder=\"输入消息...\"\r\n        :maxlength=\"1000\"\r\n        show-word-limit\r\n        @keyup.enter.ctrl=\"sendMessage\"\r\n      />\r\n      <div class=\"input-actions\">\r\n        <span class=\"tip\">按 Ctrl + Enter 发送</span>\r\n        <el-button\r\n          type=\"primary\"\r\n          :disabled=\"!inputMessage.trim()\"\r\n          @click=\"sendMessage\"\r\n        >\r\n          发送\r\n        </el-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { formatDistanceToNow } from 'date-fns'\r\nimport { zhCN } from 'date-fns/locale'\r\n\r\nexport default {\r\n  name: 'MessageChat',\r\n  props: {\r\n    targetUser: {\r\n      type: Object,\r\n      required: true\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      messages: [],\r\n      inputMessage: '',\r\n      loading: false,\r\n      hasMore: true,\r\n      page: 1,\r\n      pageSize: 20,\r\n      currentUser: this.$store.state.user\r\n    }\r\n  },\r\n  created() {\r\n    this.fetchMessages()\r\n    this.setupWebSocket()\r\n  },\r\n  beforeUnmount() {\r\n    this.cleanupWebSocket()\r\n  },\r\n  methods: {\r\n    async fetchMessages() {\r\n      this.loading = true\r\n      try {\r\n        const response = await this.$http.get(`/api/messages/chat/${this.targetUser.id}`, {\r\n          params: {\r\n            page: this.page,\r\n            size: this.pageSize\r\n          }\r\n        })\r\n        if (this.page === 1) {\r\n          this.messages = response.data.items.reverse()\r\n        } else {\r\n          this.messages.unshift(...response.data.items.reverse())\r\n        }\r\n        this.hasMore = response.data.hasMore\r\n        this.$nextTick(() => {\r\n          this.scrollToBottom()\r\n        })\r\n      } catch (error) {\r\n        this.$message.error('获取消息失败')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n    handleScroll() {\r\n      const container = this.$refs.messageContainer\r\n      if (container.scrollTop === 0 && this.hasMore) {\r\n        this.loadMore()\r\n      }\r\n    },\r\n    async loadMore() {\r\n      this.page++\r\n      await this.fetchMessages()\r\n    },\r\n    formatTime(time) {\r\n      return formatDistanceToNow(new Date(time), {\r\n        addSuffix: true,\r\n        locale: zhCN\r\n      })\r\n    },\r\n    async sendMessage() {\r\n      if (!this.inputMessage.trim()) return\r\n\r\n      try {\r\n        const response = await this.$http.post('/api/messages', {\r\n          receiverId: this.targetUser.id,\r\n          content: this.inputMessage.trim()\r\n        })\r\n        this.messages.push(response.data)\r\n        this.inputMessage = ''\r\n        this.$nextTick(() => {\r\n          this.scrollToBottom()\r\n        })\r\n      } catch (error) {\r\n        this.$message.error('发送消息失败')\r\n      }\r\n    },\r\n    scrollToBottom() {\r\n      const container = this.$refs.messageContainer\r\n      container.scrollTop = container.scrollHeight\r\n    },\r\n    showUserProfile() {\r\n      this.$router.push(`/users/${this.targetUser.id}`)\r\n    },\r\n    setupWebSocket() {\r\n      this.ws = new WebSocket(`${process.env.VUE_APP_WS_URL}/ws/messages`)\r\n      this.ws.onmessage = (event) => {\r\n        const message = JSON.parse(event.data)\r\n        if (message.senderId === this.targetUser.id) {\r\n          this.messages.push(message)\r\n          this.$nextTick(() => {\r\n            this.scrollToBottom()\r\n          })\r\n        }\r\n      }\r\n    },\r\n    cleanupWebSocket() {\r\n      if (this.ws) {\r\n        this.ws.close()\r\n      }\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.message-chat {\r\n  display: flex;\r\n  flex-direction: column;\r\n  height: 100%;\r\n  background-color: var(--background-color);\r\n}\r\n\r\n.chat-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 15px;\r\n  background-color: var(--background-color-light);\r\n  border-bottom: 1px solid var(--border-color);\r\n\r\n  .user-info {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n  }\r\n\r\n  .user-details {\r\n    display: flex;\r\n    flex-direction: column;\r\n\r\n    .username {\r\n      font-weight: bold;\r\n      color: var(--text-color);\r\n    }\r\n\r\n    .status {\r\n      font-size: 12px;\r\n      color: var(--text-color-secondary);\r\n    }\r\n  }\r\n}\r\n\r\n.message-container {\r\n  flex: 1;\r\n  overflow-y: auto;\r\n  padding: 20px;\r\n}\r\n\r\n.load-more {\r\n  display: flex;\r\n  justify-content: center;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.message-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 20px;\r\n}\r\n\r\n.message-item {\r\n  display: flex;\r\n  gap: 10px;\r\n  max-width: 80%;\r\n\r\n  &.message-mine {\r\n    flex-direction: row-reverse;\r\n    align-self: flex-end;\r\n\r\n    .message-content {\r\n      align-items: flex-end;\r\n    }\r\n\r\n    .message-bubble {\r\n      background-color: var(--primary-color);\r\n      color: white;\r\n    }\r\n  }\r\n}\r\n\r\n.message-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 5px;\r\n}\r\n\r\n.message-time {\r\n  font-size: 12px;\r\n  color: var(--text-color-secondary);\r\n}\r\n\r\n.message-bubble {\r\n  padding: 10px 15px;\r\n  background-color: var(--background-color-light);\r\n  border-radius: 8px;\r\n  word-break: break-word;\r\n}\r\n\r\n.chat-input {\r\n  padding: 15px;\r\n  background-color: var(--background-color-light);\r\n  border-top: 1px solid var(--border-color);\r\n\r\n  .input-actions {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-top: 10px;\r\n\r\n    .tip {\r\n      font-size: 12px;\r\n      color: var(--text-color-secondary);\r\n    }\r\n  }\r\n}\r\n</style> "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}